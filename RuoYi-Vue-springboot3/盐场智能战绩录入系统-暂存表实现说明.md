# 盐场智能战绩录入系统 - 暂存表实现说明

## 背景与需求

为了解决以下问题：
1. 日期选择器存在bug无法正常选择日期，且默认显示为2025-02-01
2. 编辑战绩后点击保存会直接存入数据库，但智能识别结果列表仍保留原记录，导致批量确认时生成重复数据
3. 智能识别结果界面缺少删除功能

我们实现了一个专门的暂存表(`club_ocr_pending`)来存储待确认的战绩数据。

## 实现方案

### 1. 数据库设计

创建了 `club_ocr_pending` 表作为暂存表，结构如下：

| 字段名 | 类型 | 说明 |
|-------|------|------|
| id | bigint(20) | 主键ID |
| ocr_result_id | bigint(20) | 关联OCR结果ID |
| member_id | bigint(20) | 盐场成员ID |
| member_name | varchar(50) | 成员名称 |
| kills | int(11) | 击杀数 |
| deaths | int(11) | 死亡数 |
| kd_ratio | decimal(10,2) | KD比率 |
| digging | int(11) | 刨地数 |
| revives | int(11) | 复活数 |
| record_date | date | 战绩日期 |
| create_by | varchar(64) | 创建者 |
| create_time | datetime | 创建时间 |
| update_by | varchar(64) | 更新者 |
| update_time | datetime | 更新时间 |
| del_flag | char(1) | 删除标志（0代表存在 2代表删除） |

SQL文件位置：`sql/club_ocr_pending.sql`

### 2. 后端实现

#### 实体类
- `ClubOcrPending.java` - 暂存记录实体类

#### Mapper接口和XML
- `ClubOcrPendingMapper.java` - 数据访问接口
- `ClubOcrPendingMapper.xml` - SQL映射文件

#### Service层
- `IClubOcrPendingService.java` - 服务接口
- `ClubOcrPendingServiceImpl.java` - 服务实现类，提供以下核心功能：
  - 从暂存表转移到正式战绩表（单条）
  - 从暂存表批量转移到正式战绩表

#### Controller层
在 `IntelligentBattleController.java` 中添加了以下接口：
- `/club/battle/confirm-pending` - 确认单个暂存记录
- `/club/battle/batch-confirm-pending` - 批量确认暂存记录
- `/club/battle/pending/save` - 保存暂存记录（暂存功能）
- `/club/battle/pending/{id}` - 获取/删除单个暂存记录

### 3. 前端实现

#### API接口
在 `battle.js` 中添加了以下API：
- `confirmPendingRecord(id)` - 确认单个暂存记录
- `batchConfirmPendingRecords(ocrResultId)` - 批量确认暂存记录
- `savePendingRecord(data)` - 保存暂存记录
- `getPendingRecord(id)` - 获取单个暂存记录
- `deletePendingRecord(id)` - 删除暂存记录

#### 页面功能
在 `index.vue` 中实现了：

1. **编辑功能改进**
   - 编辑战绩页面增加"暂存"按钮
   - 暂存功能只保存到暂存表，不直接添加到正式战绩表
   - 增加"设为今天"按钮方便日期设置

2. **删除功能**
   - 在智能识别结果表格中增加"删除"按钮
   - 可以删除不需要的暂存记录

3. **一键设置时间功能**
   - 在智能识别结果区域增加"一键设置时间"按钮
   - 可以一次性设置所有记录的日期为同一日期
   - 解决了日期选择器bug问题

4. **数据流程优化**
   - 智能识别结果直接保存到暂存表
   - 单条确认时从暂存表转移到正式战绩表，并删除暂存记录
   - 批量确认时批量转移数据，避免重复数据问题

## 使用流程

1. 上传图片，系统自动识别并保存到暂存表
2. 在智能识别结果区域查看识别结果
3. 可以：
   - 点击"编辑"修改记录，然后点击"暂存"保存更改
   - 点击"删除"删除不需要的记录
   - 使用"一键设置时间"统一设置所有记录的日期
4. 确认无误后：
   - 单条确认：点击"确认"按钮
   - 批量确认：点击"批量确认"按钮
5. 确认后，数据从暂存表转移到正式战绩表，暂存表记录被删除

## 优势

1. **避免重复数据**：暂存表与正式表分离，确认后才转移数据
2. **更好的操作体验**：支持暂存编辑、删除记录
3. **解决日期问题**：提供"一键设置时间"和"设为今天"功能
4. **数据一致性**：暂存和正式表之间的数据转换有严格的事务控制

## 部署说明

1. 执行SQL脚本创建表：
   ```
   sql/club_ocr_pending.sql
   ```

2. 重新编译部署后端代码

3. 重新构建前端代码

## 注意事项

1. 批量确认操作是基于OCR结果ID进行的，确保同一OCR识别的所有记录一起处理
2. 日期字段在数据库中是date类型，前端使用 yyyy-MM-dd 格式
3. 暂存记录删除是物理删除，不是逻辑删除